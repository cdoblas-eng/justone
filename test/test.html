<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Simulador de Juego</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .player { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        .log { margin-top: 10px; color: green; font-size: 0.9em; }
    </style>
</head>
<body>

<h1>Simulador de Juego con 3 Jugadores</h1>

<div class="player" id="player0">
    <h3 id="header0">RAFA</h3>
    <button onclick="crearPartida(0)">Crear partida</button>
    <button onclick="empezarPartida()">Empezar partida</button>
    <button onclick="unirsePartida(0)">Unirse a la partida</button>

    <button onclick="elegirNumero(0)">Elegir Numero</button>
    <label for="input0"></label><input type="text" id="input0" placeholder="Numero">

    <button onclick="pista(0)">Dar pista</button>
    <label for="input00"></label><input type="text" id="input00" placeholder="Pista">

    <button onclick="resolver(0)">Resolver pista</button>
    <label for="input000"></label><input type="text" id="input000" placeholder="Resolución">
    <div class="log" id="log0"></div>
</div>

<div class="player" id="player1">
    <h3 id="header1">ALADIN</h3>
    <button onclick="crearPartida(1)">Crear partida</button>
    <button onclick="empezarPartida()">Empezar partida</button>
    <button onclick="unirsePartida(1)">Unirse a la partida</button>

    <button onclick="elegirNumero(1)">Elegir Numero</button>
    <label for="input1"></label><input type="text" id="input1" placeholder="Numero">

    <button onclick="pista(1)">Dar pista</button>
    <label for="input11"></label><input type="text" id="input11" placeholder="Pista">

    <button onclick="resolver(1)">Resolver pista</button>
    <label for="input111"></label><input type="text" id="input111" placeholder="Resolución">
    <div class="log" id="log1"></div>
</div>

<div class="player" id="player2">
    <h3 id="header2">DANI</h3>
    <button onclick="crearPartida(2)">Crear partida</button>
    <button onclick="empezarPartida()">Empezar partida</button>
    <button onclick="unirsePartida(2)">Unirse a la partida</button>

    <button onclick="elegirNumero(2)">Elegir Numero</button>
    <label for="input2"></label><input type="text" id="input2" placeholder="Numero">

    <button onclick="pista(2)">Dar pista</button>
    <label for="input22"></label><input type="text" id="input22" placeholder="Pista">

    <button onclick="resolver(2)">Resolver pista</button>
    <label for="input222"></label><input type="text" id="input222" placeholder="Resolución">
    <div class="log" id="log2"></div>
</div>



<script>
    let gameId = null;
    let playerId = null;
    let playersId = []
    let playersNames = ["RAFA", "ALADIN", "DANI"]



    async function crearPartida(numJugador) {
        try {
            const response = await fetch('http://localhost:3000/justone/game/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    playerName: playersNames[numJugador]
                })

            });
            const header = document.getElementById(`header${numJugador}`);
            header.style.color = 'red';
            const respuesta = await response.json()
            console.log(respuesta)
            gameId = respuesta.gameId;
            playerId = respuesta.playerId;
            playersId[numJugador] = playerId;
            document.getElementById(`log${numJugador}`).textContent = `Partida creada con ID: ${gameId}`;
            iniciarSSE(gameId, playerId, numJugador)
        } catch (error) {
            document.getElementById(`log${numJugador}`).textContent = 'Error al crear la partida';
            console.error(error);
        }
    }

    async function unirsePartida(numJugador) {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }

        try {
            const response = await fetch(`http://localhost:3000/justone/game/join/${gameId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerName: playersNames[numJugador] })
            });

            const data = await response.json()
            playerId  = data.playerId
            playersId[numJugador] = playerId
            document.getElementById(`log${numJugador}`).textContent = `INFORMACIÓN RECIBIDA: ${JSON.stringify(data)}`;
        } catch (error) {
            document.getElementById(`log${numJugador}`).textContent = 'Error al unirse';
            console.error(error);
        }
        console.log('gameId ' + gameId);
        console.log('playerId ' + playerId);
        iniciarSSE(gameId, playerId, numJugador)
    }

    function iniciarSSE(gameId, playerId, elementId) {
        const source = new EventSource(`http://localhost:3000/justone/sse/join/${gameId}/player/${playerId}`);

        source.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const logDiv = document.getElementById(`log${elementId}`);
            console.log(`${event.data}`);
            logDiv.textContent = `[SSE] Mensaje recibido: ${data.msg}`;
        };

        source.onerror = (err) => {
            console.error(`[SSE] Error con ${playerName}`, err);
        };
    }

    async function peticion() {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }

        const response = await fetch('http://localhost:3000/justone/debug/game?gameId=' + gameId, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },

        });
        await response
    }

    async function empezarPartida() {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }

        const response = await fetch('http://localhost:3000/justone/game/start/' + gameId, {
            method: 'PUT',
        });
        await response
    }

    async function elegirNumero(numJugador) {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }
        const number = document.getElementById(`input${numJugador}`).value;

        const response = await fetch('http://localhost:3000/justone/game/' + gameId + '/giveNumber/' + number, {
            method: 'POST',
        });
    }

    async function pista(numJugador) {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }
        const palabra = document.getElementById(`input${numJugador}${numJugador}`).value;
        const response = await fetch('http://localhost:3000/justone/clue', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                playerId: playersId[numJugador],
                gameId: gameId,
                word: palabra
            })

        });
    }

    async function siguienteRonda() {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }

        const response = await fetch('http://localhost:3000/justone/game/nextRound/' + gameId, {
            method: 'POST',
        });
        await response
    }

    async function resolver(numJugador) {
        if (!gameId) {
            alert("Primero debe crearse una partida");
            return;
        }
        // console.log(palabra, numJugador);
        // console.log(document.getElementById(`input${numJugador}`).value);
        const chosenWord = document.getElementById(`input${numJugador}${numJugador}${numJugador}`).value
        const response = await fetch('http://localhost:3000/justone/game/' + gameId + '/resolve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                playerId: playersId[numJugador],
                gameId: gameId,
                word: chosenWord
            })
        });
    }
</script>
</body>
</html>
